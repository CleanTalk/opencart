<?xml version="1.0" encoding="utf-8"?> 
<modification>
    <name>Antispam by Cleantalk</name>
    <version>1.2</version>
    <author>Cleantalk Inc.</author>
    <link>https://cleantalk.org/</link>
    <code>antispambycleantalk</code>
	<file path="catalog/controller/account/register.php">        
		<operation> 
            <search><![CDATA[return !$this->error;]]></search>
            <add position="before"><![CDATA[if (empty($this->error))
        {
                require_once DIR_APPLICATION . '/controller/extension/module/cleantalk.class.php';
                                $refferrer = null;
                if (isset($_SERVER['HTTP_REFERER'])) {
                    $refferrer = htmlspecialchars((string) $_SERVER['HTTP_REFERER']);
                }

                $user_agent = null;
                if (isset($_SERVER['HTTP_USER_AGENT'])) {
                    $user_agent = htmlspecialchars((string) $_SERVER['HTTP_USER_AGENT']);
                }
                $sender_info = array(
                    'REFFERRER' => $refferrer,
                    'post_url' => $refferrer,
                    'USER_AGENT' => $user_agent
                );
                $js_on = 0;
                if (isset($_POST['ct_checkjs']) && $_POST['ct_checkjs'] == date("Y"))
                    $js_on = 1;
                $sender_info = json_encode($sender_info);   
                    $ct = new Cleantalk();
                $ct_request = new CleantalkRequest();
                $ct_request->auth_key = trim($this->config->get('module_antispambycleantalk_access_key'));
                $ct_request->sender_email = $this->request->post['email'];
                $ct_request->sender_nickname = trim($this->request->post['firstname']).' '.trim($this->request->post['lastname']);
                $ct_request->sender_ip = $ct->cleantalk_get_real_ip();
                $ct_request->agent = 'opencart-12';
                $ct_request->js_on = $js_on;
                $ct_request->sender_info = $sender_info;
                $ct_request->submit_time = (int)(time() - $_SESSION['ct_submit_time']);
                $ct->work_url = 'http://moderate.cleantalk.org';
                $ct->server_url = 'http://moderate.cleantalk.org';
                $ct_result = $ct->isAllowUser($ct_request);
                if ($ct_result->errno == 0 && $ct_result->allow == 0)
                    $this->error['warning'] = $ct_result->comment;       
    }

]]></add>
        </operation> 
                <operation> 
            <search><![CDATA[public function index() {]]></search>
            <add position="after"><![CDATA[if (session_status() == PHP_SESSION_NONE) 
                    session_start(); if (!($this->request->server['REQUEST_METHOD'] == 'POST')) $_SESSION['ct_submit_time'] = time();]]></add>
        </operation>           
    </file>
    <file path="catalog/controller/checkout/register.php">        
        <operation> 
            <search><![CDATA[// Customer Group]]></search>
            <add position="before"><![CDATA[if (empty($json['error']))
        {
                if (session_status() == PHP_SESSION_NONE) 
                    session_start();
                require_once DIR_APPLICATION . '/controller/extension/module/cleantalk.class.php';
                                $refferrer = null;
                if (isset($_SERVER['HTTP_REFERER'])) {
                    $refferrer = htmlspecialchars((string) $_SERVER['HTTP_REFERER']);
                }

                $user_agent = null;
                if (isset($_SERVER['HTTP_USER_AGENT'])) {
                    $user_agent = htmlspecialchars((string) $_SERVER['HTTP_USER_AGENT']);
                }
                $sender_info = array(
                    'REFFERRER' => $refferrer,
                    'post_url' => $refferrer,
                    'USER_AGENT' => $user_agent
                );
                $js_on = 0;
                if (isset($_POST['ct_checkjs']) && $_POST['ct_checkjs'] == date("Y"))
                    $js_on = 1;
                $sender_info = json_encode($sender_info);   
                $post_info['comment_type'] = 'order';
                $ct = new Cleantalk();
                $ct_request = new CleantalkRequest();
                $ct_request->auth_key = trim($this->config->get('module_antispambycleantalk_access_key'));
                $ct_request->sender_email = $this->request->post['email'];
                $ct_request->sender_nickname = trim($this->request->post['firstname']).' '.trim($this->request->post['lastname']);
                $ct_request->sender_ip = $ct->cleantalk_get_real_ip();
                $ct_request->agent = 'opencart-12';
                $ct_request->js_on = $js_on;
                $ct_request->post_info = $post_info;
                $ct_request->sender_info = $sender_info;
                $ct_request->submit_time = (int)(time() - $_SESSION['ct_submit_time']);
                $ct->work_url = 'http://moderate.cleantalk.org';
                $ct->server_url = 'http://moderate.cleantalk.org';
                $ct_result = $ct->isAllowUser($ct_request);
                if ($ct_result->errno == 0 && $ct_result->allow == 0)
                    $json['error']['warning'] = $ct_result->comment;           
    }

]]></add>
        </operation>          
    </file>
    <file path="catalog/controller/checkout/guest.php">        
        <operation> 
            <search><![CDATA[// Customer Group]]></search>
            <add position="before"><![CDATA[if (empty($json['error']))
        {
                if (session_status() == PHP_SESSION_NONE) 
                    session_start();
                require_once DIR_APPLICATION . '/controller/extension/module/cleantalk.class.php';
                                $refferrer = null;
                if (isset($_SERVER['HTTP_REFERER'])) {
                    $refferrer = htmlspecialchars((string) $_SERVER['HTTP_REFERER']);
                }

                $user_agent = null;
                if (isset($_SERVER['HTTP_USER_AGENT'])) {
                    $user_agent = htmlspecialchars((string) $_SERVER['HTTP_USER_AGENT']);
                }
                $sender_info = array(
                    'REFFERRER' => $refferrer,
                    'post_url' => $refferrer,
                    'USER_AGENT' => $user_agent
                );
                $js_on = 0;
                if (isset($_POST['ct_checkjs']) && $_POST['ct_checkjs'] == date("Y"))
                    $js_on = 1;
                $sender_info = json_encode($sender_info);   
                    $ct = new Cleantalk();
                $ct_request = new CleantalkRequest();
                $post_info['comment_type'] = 'order';
                $ct_request->auth_key = trim($this->config->get('module_antispambycleantalk_access_key'));
                $ct_request->sender_email = $this->request->post['email'];
                $ct_request->sender_nickname = trim($this->request->post['firstname']).' '.trim($this->request->post['lastname']);
                $ct_request->sender_ip = $ct->cleantalk_get_real_ip();
                $ct_request->agent = 'opencart-12';
                $ct_request->js_on = $js_on;
                $ct_request->post_info = $post_info;
                $ct_request->sender_info = $sender_info;
                $ct_request->submit_time = (int)(time() - $_SESSION['ct_submit_time']);
                $ct->work_url = 'http://moderate.cleantalk.org';
                $ct->server_url = 'http://moderate.cleantalk.org';
                $ct_result = $ct->isAllowUser($ct_request);
                if ($ct_result->errno == 0 && $ct_result->allow == 0)
                    $json['error']['warning'] = $ct_result->comment;           
    }

]]></add>
        </operation>          
    </file> 
    <file path="catalog/controller/product/product.php">        
        <operation> 
            <search><![CDATA[if (!isset($json['error'])) {
                $this->load->model('catalog/review');

                $this->model_catalog_review->addReview($this->request->get['product_id'], $this->request->post);

                $json['success'] = $this->language->get('text_success');
            }]]></search>
            <add position="replace"><![CDATA[if (!isset($json['error'])) {
                if (session_status() == PHP_SESSION_NONE) 
                    session_start();
                require_once DIR_APPLICATION . '/controller/extension/module/cleantalk.class.php';
                $refferrer = null;
                if (isset($_SERVER['HTTP_REFERER'])) {
                    $refferrer = htmlspecialchars((string) $_SERVER['HTTP_REFERER']);
                }

                $user_agent = null;
                if (isset($_SERVER['HTTP_USER_AGENT'])) {
                    $user_agent = htmlspecialchars((string) $_SERVER['HTTP_USER_AGENT']);
                }
                $sender_info = array(
                    'REFFERRER' => $refferrer,
                    'post_url' => $refferrer,
                    'USER_AGENT' => $user_agent
                );
                $js_on = 0;
                if (isset($_POST['ct_checkjs']) && $_POST['ct_checkjs'] == date("Y"))
                    $js_on = 1;
                $sender_info = json_encode($sender_info);   
                $ct = new Cleantalk();
                $ct_request = new CleantalkRequest();
                $ct_request->auth_key = trim($this->config->get('module_antispambycleantalk_access_key'));
                $ct_request->sender_nickname = trim($this->request->post['name']);
                $ct_request->sender_ip = $ct->cleantalk_get_real_ip();
                $ct_request->message = trim($this->request->post['text']);
                $ct_request->agent = 'opencart-12';
                $ct_request->js_on = $js_on;
                $ct_request->sender_info = $sender_info;
                $ct_request->submit_time = (int)(time() - $_SESSION['ct_submit_time']);
                $ct->work_url = 'http://moderate.cleantalk.org';
                $ct->server_url = 'http://moderate.cleantalk.org';
                $ct_result = $ct->isAllowMessage($ct_request);
                if ($ct_result->errno == 0 && $ct_result->allow == 0)
                    $json['error'] = $ct_result->comment;
                else 
                {
                    $this->load->model('catalog/review');

                    $this->model_catalog_review->addReview($this->request->get['product_id'], $this->request->post);

                    $json['success'] = $this->language->get('text_success');                
                }               

            }]]></add>
        </operation> 
                <operation> 
            <search><![CDATA[public function index() {]]></search>
            <add position="after"><![CDATA[if (session_status() == PHP_SESSION_NONE) 
                    session_start(); if (!($this->request->server['REQUEST_METHOD'] == 'POST')) $_SESSION['ct_submit_time'] = time();]]></add>
        </operation>           
    </file>  
    <file path = "catalog/controller/checkout/checkout.php">
                        <operation> 
            <search><![CDATA[public function index() {]]></search>
            <add position="after"><![CDATA[if (session_status() == PHP_SESSION_NONE) 
                    session_start(); $_SESSION['ct_submit_time'] = time();]]></add>
        </operation>  
    </file>
        <file path="catalog/view/theme/*/template/account/register.twig">        
        <operation> 
            <search><![CDATA[<input type="submit" value="{{ button_continue }}" class="btn btn-primary" />]]></search>
            <add position="after"><![CDATA[<input type="hidden" name="ct_checkjs" id="ct_checkjs" value="0" />]]></add>
        </operation>
        <operation> 
            <search><![CDATA[<script type="text/javascript"><!--]]></search>
            <add position="after"><![CDATA[var date = new Date(); document.getElementById("ct_checkjs").value = date.getFullYear();]]></add>
        </operation>              
    </file>
        <file path="catalog/view/theme/*/template/checkout/register.twig">        
        <operation> 
            <search><![CDATA[<input type="button" value="{{ button_continue }}" id="button-register" data-loading-text="{{ text_loading }}" class="btn btn-primary" />]]></search>
            <add position="after"><![CDATA[<input type="hidden" name="ct_checkjs" id="ct_checkjs" value="0" />]]></add>
        </operation>
        <operation> 
            <search><![CDATA[<script type="text/javascript"><!--]]></search>
            <add position="after"><![CDATA[var date = new Date(); document.getElementById("ct_checkjs").value = date.getFullYear();]]></add>
        </operation>              
    </file>
        <file path="catalog/view/theme/*/template/checkout/guest.twig">        
        <operation> 
            <search><![CDATA[<input type="button" value="{{ button_continue }}" id="button-guest" data-loading-text="{{ text_loading }}" class="btn btn-primary" />]]></search>
            <add position="after"><![CDATA[<input type="hidden" name="ct_checkjs" id="ct_checkjs" value="0" />]]></add>
        </operation>
        <operation> 
            <search><![CDATA[<script type="text/javascript"><!--]]></search>
            <add position="after"><![CDATA[var date = new Date(); document.getElementById("ct_checkjs").value = date.getFullYear();]]></add>
        </operation>              
    </file>
        <file path="catalog/view/theme/*/template/product/product.twig">        
        <operation> 
            <search><![CDATA[<div class="buttons clearfix">]]></search>
            <add position="before"><![CDATA[<input type="hidden" name="ct_checkjs" id="ct_checkjs" value="0" />]]></add>
        </operation>
        <operation> 
            <search><![CDATA[<script type="text/javascript"><!--]]></search>
            <add position="after"><![CDATA[var date = new Date(); document.getElementById("ct_checkjs").value = date.getFullYear();]]></add>
        </operation>              
    </file
</modification>
